<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mystic Night Tarot | ä»Šã®å¿ƒç†ãƒãƒ©ãƒ³ã‚¹è¨ºæ–­</title>
  <meta name="description" content="ã‚¿ãƒ­ãƒƒãƒˆ Ã— ç›´æ„Ÿ Ã— å¿ƒç†ãƒ†ã‚¹ãƒˆã§ã€ã„ã¾ã®ã‚ãªãŸã®å¿ƒç†ãƒãƒ©ãƒ³ã‚¹ã‚’è¨ºæ–­ã—ã¾ã™ã€‚ã‚¹ãƒãƒ›å‘ã‘å ã„ã‚¢ãƒ—ãƒªï¼ˆå˜ä¸€HTMLï¼‰ã€‚" />
  <style>
    :root{
      --bg:#0b1020;          /* å¤œç©ºãƒ™ãƒ¼ã‚¹ */
      --bg2:#060913;         /* å¤œç©ºæ¿ƒè‰² */
      --accent:#a687ff;      /* æ˜Ÿæ˜ã‚Šã®ç´« */
      --accent2:#7cc7ff;     /* æœˆå…‰ã®é’ */
      --card:#111629;        /* ã‚«ãƒ¼ãƒ‰è£ã®æ¿ƒç´º */
      --card-edge:#1f2540;   /* ã‚«ãƒ¼ãƒ‰ç¸ */
      --text:#e8ebff;        /* æ–‡å­—è‰² */
      --muted:#aab1d6;
      --success:#7dffb3;
      --warning:#ffd166;
      --danger:#ff6b6b;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 70% -10%, #1a2150 0%, var(--bg) 45%, var(--bg2) 100%);
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    /* æ˜Ÿã®ç¬ã */
    .stars, .stars:after{
      position:fixed; inset:0; content:""; pointer-events:none; z-index:-1;
      background: transparent;
    }
    .stars:after{ animation: twinkle 8s linear infinite; box-shadow: var(--star-field); }
    @keyframes twinkle{
      0%,100%{opacity:0.9} 50%{opacity:0.3}
    }

    /* ã‚³ãƒ³ãƒ†ãƒŠ */
    .wrap{ max-width: 720px; margin: 0 auto; padding: 16px 14px 28px; }

    header{ display:flex; align-items:center; gap:10px; padding:14px 0 8px; position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:linear-gradient( to bottom, rgba(6,9,19,0.8), rgba(6,9,19,0.0) ); z-index:5;}
    header .moon{ width:30px; height:30px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff 0%, #b7d7ff 50%, #6ea6ff 65%, #2c4d7a 100%); box-shadow:0 0 18px #7cc7ff66; }
    header h1{ font-size: clamp(18px, 4.5vw, 22px); margin:0; letter-spacing:0.06em; font-weight:700; }

    .card-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; padding:10px 2px 2px; }
    .tarot{ aspect-ratio: 2.1/3.4; border-radius:14px; background: linear-gradient(145deg, #0f1531, #171c3a); position:relative; border:1px solid var(--card-edge); box-shadow: 0 10px 18px rgba(0,0,0,.35), inset 0 1px 0 #445; cursor:pointer; transform: translateZ(0); }
    .tarot::after{ content:""; position:absolute; inset:10px; border-radius:10px; background: conic-gradient(from 0.25turn, #b5a1ff55, #7cc7ff44, #ffffff22, #b5a1ff55); mask: radial-gradient(closest-side, #0007 80%, transparent 82%) ,linear-gradient(#000,#000); }
    .tarot .sigil{ position:absolute; inset:auto 0 10% 0; margin:auto; text-align:center; font-size: clamp(20px, 6vw, 36px); opacity:.9; filter: drop-shadow(0 2px 4px rgba(0,0,0,.5)); }
    .tarot .stars{ position:absolute; inset:0; opacity:.35; mix-blend-mode:screen; }
    .tarot:active{ transform:scale(.98); }

    .section{ margin: 10px 0 16px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.07); border-radius:16px; padding:12px 12px 14px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .section h2{ margin:0 0 10px; font-size: clamp(15px, 4.2vw, 18px); letter-spacing: .04em; color: var(--accent2); }
    .lead{ color:var(--muted); font-size: 14px; line-height:1.6; }

    .q-choices{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px; }
    .choice{ border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:12px; background:rgba(255,255,255,.02); font-size:15px; }
    .choice input{ margin-right:8px; accent-color: var(--accent2); }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .btn{ flex:1 1 auto; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background: linear-gradient(180deg, rgba(124,199,255,.12), rgba(166,135,255,.10)); color:var(--text); font-weight:600; letter-spacing:.04em; cursor:pointer; text-decoration:none; }
    .btn.secondary{ background: rgba(255,255,255,.04); }
    .btn:active{ transform: translateY(1px); }

    .reveal{
      perspective: 1000px; display:grid; place-items:center; min-height: 240px; position:relative; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(145deg, rgba(31,37,64,.7), rgba(10,12,25,.6));
    }
    .reveal-card{ width:min(260px, 70%); aspect-ratio:2.1/3.4; border-radius:14px; position:relative; transform-style:preserve-3d; transition:transform 700ms cubic-bezier(.2,.7,.2,1); }
    .reveal-card.flipped{ transform: rotateY(180deg); }
    .face{ position:absolute; inset:0; backface-visibility:hidden; border-radius:inherit; border:1px solid var(--card-edge); box-shadow: 0 14px 28px rgba(0,0,0,.45), inset 0 1px 0 #445; display:grid; place-items:center; padding:14px; }
    .front{ background: linear-gradient(145deg, #0f1531, #171c3a); }
    .back{ background: radial-gradient(60% 60% at 50% 25%, #1f2648, #0d132a 60%, #0a0f22 100%); transform: rotateY(180deg); text-align:center; }
    .back h3{ margin:10px 0 6px; font-size:18px; letter-spacing:.06em; }
    .back p{ margin:0; color:var(--muted); font-size:14px; }

    .bars{ display:grid; grid-template-columns:1fr; gap:8px; margin:10px 0; }
    .bar{ background: rgba(255,255,255,.07); border-radius:10px; overflow:hidden; height:12px; }
    .bar>span{ display:block; height:100%; background: linear-gradient(90deg, var(--accent2), var(--accent)); width:0%; transition: width 900ms ease; }
    .score-row{ display:flex; justify-content:space-between; font-size:13px; color:var(--muted); }

    .result{ line-height:1.7; font-size:15px; color:#e9ecff; }

    .ad-slot{ margin-top:12px; border:1px dashed rgba(255,255,255,.15); border-radius:12px; padding:14px; text-align:center; color:var(--muted); font-size:12px; }

    footer{ margin: 18px 0 40px; text-align:center; color:var(--muted); font-size:12px; }
    .small{ font-size:12px; color:var(--muted); }

    /* å°ã•ã‚ç«¯æœ«å‘ã‘å¾®èª¿æ•´ */
    @media (max-width:360px){
      .card-grid{ gap:8px; }
      .btn{ padding:10px 12px; font-size:14px; }
      .choice{ padding:10px; font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="wrap">
    <header>
      <div class="moon" aria-hidden="true"></div>
      <h1>Mystic Night Tarot â€“ ä»Šã®å¿ƒç†ãƒãƒ©ãƒ³ã‚¹è¨ºæ–­</h1>
    </header>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã‚«ãƒ¼ãƒ‰é¸æŠ -->
    <section class="section" id="step1">
      <h2>â‘  ç›´æ„Ÿã§1æšé¸ã‚“ã§ãã ã•ã„</h2>
      <p class="lead">ç›®ã‚’é–‰ã˜ã¦æ·±å‘¼å¸ã‚’ã²ã¨ã¤ã€‚æœ€åˆã«æ°—ã«ãªã£ãŸã‚«ãƒ¼ãƒ‰ãŒã€ã„ã¾ã®ã‚ãªãŸã‚’æ˜ ã—ã¾ã™ã€‚</p>
      <div class="card-grid" id="cardGrid" aria-label="ã‚«ãƒ¼ãƒ‰ä¸€è¦§"></div>
      <div class="small" style="margin-top:8px;">â€» 6æšã®ã†ã¡ä¸€æšã‚’ã‚¿ãƒƒãƒ—</div>
    </section>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2ï¼šå¿ƒç†ãƒ†ã‚¹ãƒˆï¼ˆè¨€è‘‰ã®é¸æŠï¼‰ -->
    <section class="section" id="step2" hidden>
      <h2>â‘¡ ã„ã¾ä¸€ç•ªã—ã£ãã‚Šæ¥ã‚‹è¨€è‘‰ã¯ï¼Ÿ</h2>
      <p class="lead">ç›´æ„Ÿã§é¸ã‚“ã§ãã ã•ã„ã€‚çµæœã®â€œãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹â€ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</p>
      <div class="q-choices" id="qChoices"></div>
      <div class="btns">
        <button class="btn" id="seeResultBtn" disabled>çµæœã‚’è¦‹ã‚‹</button>
        <button class="btn secondary" id="reselectBtn">ã‚«ãƒ¼ãƒ‰ã‚’é¸ã³ç›´ã™</button>
      </div>
    </section>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—3ï¼šçµæœè¡¨ç¤ºï¼ˆã‚«ãƒ¼ãƒ‰ã‚ãã‚Šï¼‹å¿ƒç†ãƒãƒ©ãƒ³ã‚¹ï¼‰ -->
    <section class="section" id="step3" hidden>
      <h2>â‘¢ çµæœ</h2>
      <div class="reveal">
        <div class="reveal-card" id="revealCard" aria-live="polite">
          <div class="face front" id="frontFace"></div>
          <div class="face back" id="backFace">
            <div>
              <div style="font-size:40px; line-height:1" id="cardEmoji">ğŸœ‚</div>
              <h3 id="cardTitle">---</h3>
              <p id="cardPose" class="small">æ­£ä½ç½®</p>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="score-row"><span>æ€è€ƒ</span><span id="pctThink">0%</span></div>
        <div class="bar"><span id="barThink"></span></div>
        <div class="score-row"><span>æ„Ÿæƒ…</span><span id="pctFeel">0%</span></div>
        <div class="bar"><span id="barFeel"></span></div>
        <div class="score-row"><span>è¡Œå‹•</span><span id="pctAct">0%</span></div>
        <div class="bar"><span id="barAct"></span></div>
        <div class="score-row"><span>ç›´æ„Ÿ</span><span id="pctIntui">0%</span></div>
        <div class="bar"><span id="barIntui"></span></div>
      </div>

      <div class="result" id="resultText" style="margin-top:12px"></div>

      <div class="btns">
        <button class="btn" id="againBtn">ã‚‚ã†ä¸€åº¦</button>
        <a class="btn secondary" id="shareBtn">çµæœã‚’ã‚·ã‚§ã‚¢</a>
        <a class="btn secondary" id="consultBtn" href="#" target="_blank" rel="noopener">è©³ã—ã„é‘‘å®šã‚’ä¾é ¼</a>
      </div>

      <div class="ad-slot" aria-label="åºƒå‘Šæ ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰">
        ï¼ˆåºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ï¼‰<br/>
        AdSense ã‚’ä½¿ã†å ´åˆã¯ã€ã“ã®æ ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
      </div>
    </section>

    <footer>
      Â© <span id="year"></span> Mystic Night Tarot
    </footer>
  </div>

  <script>
    // ---- æ˜Ÿã®ã°ã‚‰ã¾ãï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ãŸç°¡æ˜“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
    const starCount = 140;
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
    const starPositions = Array.from({length: starCount}, () => {
      const x = Math.floor(Math.random()*vw);
      const y = Math.floor(Math.random()*vh*1.2);
      const blur = Math.random()*2;
      return `${x}px ${y}px ${blur}px rgba(255,255,255,${0.6+Math.random()*0.4})`;
    }).join(',');
    document.documentElement.style.setProperty('--star-field', starPositions);

    // ---- ã‚¿ãƒ­ãƒƒãƒˆç°¡æ˜“ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸»è¦ã‚¢ãƒ«ã‚«ãƒŠä¸€éƒ¨ + çµµæ–‡å­—ï¼‰
    const TAROT = [
      { id:'the-sun', name:'å¤ªé™½', emoji:'â˜€ï¸', upright:'ç”Ÿå‘½åŠ›ãƒ»æˆåŠŸãƒ»å–œã³ãƒ»å¯è¦–åŒ–', reversed:'ç©ºå›ã‚Šãƒ»è‡ªä¿¡éå‰°ãƒ»ç„¦ã‚Š' },
      { id:'the-moon', name:'æœˆ', emoji:'ğŸŒ™', upright:'ç„¡æ„è­˜ãƒ»ç›´æ„Ÿãƒ»æ›–æ˜§ã•ãƒ»æƒ³åƒåŠ›', reversed:'æ··ä¹±ãƒ»ä¸å®‰ãƒ»èª¤è§£' },
      { id:'the-star', name:'æ˜Ÿ', emoji:'â­', upright:'å¸Œæœ›ãƒ»ã²ã‚‰ã‚ããƒ»ç™’ã—ãƒ»å†ç”Ÿ', reversed:'æœŸå¾…ã¯ãšã‚Œãƒ»è‡ªå·±ä¸ä¿¡' },
      { id:'the-hermit', name:'éš è€…', emoji:'ğŸ•¯ï¸', upright:'å†…çœãƒ»æ¢æ±‚ãƒ»é™ã‘ã•', reversed:'å­¤ç«‹ãƒ»é–‰å¡ãƒ»ã“ã ã‚ã‚Š' },
      { id:'strength', name:'åŠ›', emoji:'ğŸ¦', upright:'å‹‡æ°—ãƒ»å„ªã—ã•ãƒ»è‡ªå·±åˆ¶å¾¡', reversed:'è¡å‹•ãƒ»è‡ªä¿¡ã®æºã‚‰ã' },
      { id:'justice', name:'æ­£ç¾©', emoji:'âš–ï¸', upright:'å…¬å¹³ãƒ»èª¿æ•´ãƒ»ãƒãƒ©ãƒ³ã‚¹', reversed:'åã‚Šãƒ»è¿·ã„ãƒ»ä¸å‡è¡¡' },
      { id:'wheel', name:'é‹å‘½ã®è¼ª', emoji:'ğŸ¡', upright:'è»¢æ©Ÿãƒ»æµã‚Œã«ä¹—ã‚‹ãƒ»ã‚·ãƒ³ã‚¯ãƒ­', reversed:'åœæ»ãƒ»ç©ºå›ã‚Š' },
      { id:'death', name:'æ­»ç¥', emoji:'ğŸ¦‹', upright:'çµ‚ã‚ã‚Šã¨å§‹ã¾ã‚Šãƒ»è„±çš®', reversed:'æ‰‹æ”¾ã›ãªã„ãƒ»å»¶å‘½ç­–' },
      { id:'lovers', name:'æ‹äºº', emoji:'ğŸ’', upright:'é¸æŠãƒ»ã¨ãã‚ããƒ»èª¿å’Œ', reversed:'å„ªæŸ”ä¸æ–­ãƒ»ä¸ä¸€è‡´' },
      { id:'magician', name:'é­”è¡“å¸«', emoji:'ğŸª„', upright:'ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»æ„æ€ãƒ»è¡¨ç¾', reversed:'æº–å‚™ä¸è¶³ãƒ»æ•£æ¼«' },
      { id:'priestess', name:'å¥³æ•™çš‡', emoji:'ğŸ“˜', upright:'æ´å¯Ÿãƒ»é™è¦³ãƒ»ç›´æ„Ÿã®ç²¾åº¦', reversed:'éå‰°åˆ†æãƒ»å†·ãŸã•' },
      { id:'empress', name:'å¥³å¸', emoji:'ğŸŒ¿', upright:'è±Šã‹ã•ãƒ»è‚²æˆãƒ»å…±æ„Ÿ', reversed:'ç”˜ã‚„ã‹ã—ãƒ»éå¤š' }
    ];

    // å¿ƒç†ãƒ†ã‚¹ãƒˆã®é¸æŠè‚¢ï¼ˆãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’é‡ã¿ä»˜ã‘ï¼‰
    const CHOICES = [
      { key:'å®‰å¿ƒ', weights:{ think:+6, feel:+10, act:-2, intui:+2 }, tone:'å®‰å®šã¨ã‚„ã•ã—ã•ã‚’æ±‚ã‚ã‚‹æ³¢é•·ã€‚' },
      { key:'å¤‰åŒ–', weights:{ think:+2, feel:-2, act:+10, intui:+4 }, tone:'æ›´æ–°ã¨å‰é€²ã®é¢¨ã‚’å–ã‚Šè¾¼ã‚€æ³¢é•·ã€‚' },
      { key:'å†’é™º', weights:{ think:-2, feel:+2, act:+8, intui:+12 }, tone:'æœªçŸ¥ã«é–‹ãæ‰‰ã¸é£›ã³è¾¼ã‚€æ³¢é•·ã€‚' }
    ];

    // UIå‚ç…§
    const grid = document.getElementById('cardGrid');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const qBox = document.getElementById('qChoices');
    const seeBtn = document.getElementById('seeResultBtn');
    const reselectBtn = document.getElementById('reselectBtn');

    const revealCard = document.getElementById('revealCard');
    const frontFace = document.getElementById('frontFace');
    const backFace  = document.getElementById('backFace');
    const cardTitle = document.getElementById('cardTitle');
    const cardPose  = document.getElementById('cardPose');
    const cardEmoji = document.getElementById('cardEmoji');

    const bars = {
      think: document.getElementById('barThink'),
      feel:  document.getElementById('barFeel'),
      act:   document.getElementById('barAct'),
      intui: document.getElementById('barIntui')
    };
    const pcts = {
      think: document.getElementById('pctThink'),
      feel:  document.getElementById('pctFeel'),
      act:   document.getElementById('pctAct'),
      intui: document.getElementById('pctIntui')
    };
    const resultText = document.getElementById('resultText');

    const againBtn = document.getElementById('againBtn');
    const shareBtn = document.getElementById('shareBtn');
    const consultBtn = document.getElementById('consultBtn');

    document.getElementById('year').textContent = new Date().getFullYear();

    // çŠ¶æ…‹
    let chosenIndex = null;   // TAROTã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let upright = true;       // æ­£ä½ç½®/é€†ä½ç½®
    let choice = null;        // CHOICESã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

    // åˆæœŸåŒ–ï¼š6æšã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã³ç›´ã™
    function setupGrid(){
      grid.innerHTML = '';
      chosenIndex = null; upright = true; choice = null;
      step2.hidden = true; step3.hidden = true; seeBtn.disabled = true;

      const pool = shuffle([...TAROT]).slice(0,6);
      pool.forEach((cardObj, i)=>{
        const el = document.createElement('button');
        el.className = 'tarot'; el.setAttribute('aria-label', 'ã‚«ãƒ¼ãƒ‰'+(i+1));
        el.innerHTML = `<div class="sigil">âœ´ï¸</div>`;
        el.addEventListener('click', ()=> onPick(pool, cardObj));
        grid.appendChild(el);
      });
    }

    function onPick(pool, cardObj){
      // é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜
      chosenIndex = TAROT.findIndex(t => t.id === cardObj.id);
      upright = Math.random() > 0.5; // 50%ã§é€†ä½ç½®

      // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå¿ƒç†ãƒ†ã‚¹ãƒˆï¼‰
      renderQuestion();
      step2.hidden = false;
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      step2.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function renderQuestion(){
      qBox.innerHTML = '';
      CHOICES.forEach((c,i)=>{
        const id = 'c'+i;
        const label = document.createElement('label');
        label.className = 'choice';
        label.innerHTML = `<input type="radio" name="tone" id="${id}" value="${c.key}"/> ${c.key} â€” <span class="small">${c.tone}</span>`;
        qBox.appendChild(label);
      });
      qBox.addEventListener('change', (ev)=>{
        const val = ev.target && ev.target.value;
        choice = CHOICES.find(c=>c.key===val) || null;
        seeBtn.disabled = !choice;
      }, { once:true });
    }

    // çµæœç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    function compute(){
      const card = TAROT[chosenIndex];
      const poseText = upright ? 'æ­£ä½ç½®' : 'é€†ä½ç½®';
      const base = seedFrom(card.id + poseText + new Date().toDateString());
      // 4è»¸ 0-100
      let think = 40 + ((base%23)-11); // -11..+11
      let feel  = 40 + ((base%19)-9);
      let act   = 40 + ((base%17)-8);
      let intui = 40 + ((base%29)-14);
      // ã‚«ãƒ¼ãƒ‰æ€§è³ªã®è£œæ­£
      const bias = {
        'the-sun':     {think:+4, feel:+8, act:+10, intui:+0},
        'the-moon':    {think:-4, feel:+6, act:-2, intui:+12},
        'the-star':    {think:+2, feel:+6, act:+2, intui:+10},
        'the-hermit':  {think:+10,feel:+0, act:-4, intui:+6},
        'strength':    {think:+2, feel:+6, act:+8, intui:+0},
        'justice':     {think:+10,feel:+2, act:+0, intui:+0},
        'wheel':       {think:+0, feel:+2, act:+10,intui:+6},
        'death':       {think:+4, feel:+0, act:+8, intui:+4},
        'lovers':      {think:-2, feel:+10,act:+2, intui:+2},
        'magician':    {think:+8, feel:+0, act:+8, intui:+2},
        'priestess':   {think:+8, feel:+0, act:-2, intui:+10},
        'empress':     {think:+2, feel:+10,act:+0, intui:+2}
      }[card.id] || {think:0, feel:0, act:0, intui:0};

      if(!upright){ // é€†ä½ç½®ã¯ä¸€éƒ¨è»¸ã‚’å¼±ã‚ã‚‹
        think -= 4; feel -= 4; act -= 6; intui -= 2;
      }
      // å¿ƒç†ãƒ†ã‚¹ãƒˆã®é‡ã¿
      if(choice){
        think += choice.weights.think;
        feel  += choice.weights.feel;
        act   += choice.weights.act;
        intui += choice.weights.intui;
      }
      // ã‚«ãƒ¼ãƒ‰å›ºæœ‰è£œæ­£
      think += bias.think; feel += bias.feel; act += bias.act; intui += bias.intui;

      // 0-100ã«ã‚¯ãƒ©ãƒ³ãƒ—
      const clamp = v => Math.max(0, Math.min(100, Math.round(v)));
      think = clamp(think); feel = clamp(feel); act = clamp(act); intui = clamp(intui);

      return { card, poseText, scores:{think,feel,act,intui} };
    }

    // çµæœãƒ†ã‚­ã‚¹ãƒˆ
    function buildText(card, poseText, scores){
      const keyline = uprightMsg(card, poseText);
      const focus = Object.entries(scores).sort((a,b)=>b[1]-a[1])[0][0];
      const axisJP = {think:'æ€è€ƒ', feel:'æ„Ÿæƒ…', act:'è¡Œå‹•', intui:'ç›´æ„Ÿ'};

      const advice = {
        think: 'è€ƒãˆã‚’ç´™ã«æ›¸ãå‡ºã™ã¨ã€æ··ç·šãŒã»ã©ã‘ã¦ã„ãã¾ã™ã€‚3è¡Œã§OKã€‚',
        feel:  'æ„Ÿæƒ…ã‚’å¦å®šã—ãªã„ã§ã€ã¾ãšã€Œã„ã¾ã“ã†æ„Ÿã˜ã¦ã‚‹ã€ã¨è¨€è‘‰ã«ã€‚',
        act:   '5åˆ†ã ã‘å‹•ãã€‚çŸ­æ™‚é–“ã®ç€æ‰‹ãŒæµã‚Œã‚’ä½œã‚Šã¾ã™ã€‚',
        intui: 'ç¬¬ä¸€å°è±¡ã‚’å°Šé‡ã—ã¦ã€‚ãŸã ã—ä¸€æ‹ç½®ã„ã¦äº‹å®Ÿç¢ºèªã‚‚ã€‚'
      }[focus];

      const nuance = choice ? choice.tone : '';

      return `ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘${keyline}\nã€ã„ã¾å¼·ã„è»¸ã€‘${axisJP[focus]}\n${nuance}\n${card.name}ã®ç¤ºã™æ™¯è‰²ã«ã€ã‚ãªãŸã®ç¾åœ¨åœ°ãŒé‡ãªã£ã¦ã„ã¾ã™ã€‚`;
    }

    function uprightMsg(card, poseText){
      const t = upright ? card.upright : card.reversed;
      return `${card.name}ï¼${poseText}ï¼š${t}`;
    }

    // ä¹±æ•°ãƒ˜ãƒ«ãƒ‘
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }
    function seedFrom(str){
      let h=0; for(let i=0;i<str.length;i++){ h = Math.imul(31,h)+str.charCodeAt(i)|0; } return Math.abs(h);
    }

    // UIå‹•ä½œ
    seeBtn.addEventListener('click', ()=>{
      if(chosenIndex==null || !choice) return;
      const { card, poseText, scores } = compute();

      // ã‚«ãƒ¼ãƒ‰é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      frontFace.innerHTML = '';
      backFace.querySelector('#cardEmoji').textContent = card.emoji;
      cardTitle.textContent = card.name;
      cardPose.textContent  = poseText;

      revealCard.classList.remove('flipped');
      setTimeout(()=>{ revealCard.classList.add('flipped'); }, 60);

      // ãƒãƒ¼ã®æ›´æ–°
      bars.think.style.width = scores.think+'%'; pcts.think.textContent = scores.think+'%';
      bars.feel.style.width  = scores.feel+'%';  pcts.feel.textContent  = scores.feel+'%';
      bars.act.style.width   = scores.act+'%';   pcts.act.textContent   = scores.act+'%';
      bars.intui.style.width = scores.intui+'%'; pcts.intui.textContent = scores.intui+'%';

      // ãƒ†ã‚­ã‚¹ãƒˆ
      resultText.textContent = buildText(card, poseText, scores);

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡æ›¿
      step3.hidden = false; step3.scrollIntoView({behavior:'smooth', block:'start'});
    });

    reselectBtn.addEventListener('click', ()=>{ setupGrid(); window.scrollTo({top:0, behavior:'smooth'}); });
    againBtn.addEventListener('click', ()=>{ setupGrid(); window.scrollTo({top:0, behavior:'smooth'}); });

    // å…±æœ‰
    shareBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const text = `Mystic Night Tarotã§å¿ƒç†ãƒãƒ©ãƒ³ã‚¹ã‚’è¨ºæ–­ã—ã¾ã—ãŸã€‚\n${resultText.textContent}`;
      if(navigator.share){
        try{ await navigator.share({ title: 'å¿ƒç†ãƒãƒ©ãƒ³ã‚¹è¨ºæ–­', text, url: location.href }); }catch(err){}
      }else{
        navigator.clipboard.writeText(text).then(()=>{
          shareBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'; setTimeout(()=>shareBtn.textContent='çµæœã‚’ã‚·ã‚§ã‚¢', 1400);
        });
      }
    });

    // ç›¸è«‡ãƒªãƒ³ã‚¯ï¼ˆä»»æ„ã§å·®ã—æ›¿ãˆï¼‰
    consultBtn.addEventListener('click', (e)=>{
      if(consultBtn.getAttribute('href')==='#'){
        e.preventDefault();
        alert('ã€Œè©³ã—ã„é‘‘å®šã‚’ä¾é ¼ã€ãƒªãƒ³ã‚¯ã¯ã€ã‚ãªãŸã®LINEå…¬å¼ãƒ»äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ URLã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚');
      }
    });

    // èµ·å‹•
    setupGrid();
  </script>
</body>
</html>

