<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mystic Night Tarot | 今の心理バランス診断</title>
  <meta name="description" content="タロット × 直感 × 心理テストで、いまのあなたの心理バランスを診断します。スマホ向け占いアプリ（単一HTML）。" />
  <style>
    :root{
      --bg:#0b1020;          /* 夜空ベース */
      --bg2:#060913;         /* 夜空濃色 */
      --accent:#a687ff;      /* 星明りの紫 */
      --accent2:#7cc7ff;     /* 月光の青 */
      --card:#111629;        /* カード裏の濃紺 */
      --card-edge:#1f2540;   /* カード縁 */
      --text:#e8ebff;        /* 文字色 */
      --muted:#aab1d6;
      --success:#7dffb3;
      --warning:#ffd166;
      --danger:#ff6b6b;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 70% -10%, #1a2150 0%, var(--bg) 45%, var(--bg2) 100%);
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    /* 星の瞬き */
    .stars, .stars:after{
      position:fixed; inset:0; content:""; pointer-events:none; z-index:-1;
      background: transparent;
    }
    .stars:after{ animation: twinkle 8s linear infinite; box-shadow: var(--star-field); }
    @keyframes twinkle{
      0%,100%{opacity:0.9} 50%{opacity:0.3}
    }

    /* コンテナ */
    .wrap{ max-width: 720px; margin: 0 auto; padding: 16px 14px 28px; }

    header{ display:flex; align-items:center; gap:10px; padding:14px 0 8px; position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:linear-gradient( to bottom, rgba(6,9,19,0.8), rgba(6,9,19,0.0) ); z-index:5;}
    header .moon{ width:30px; height:30px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff 0%, #b7d7ff 50%, #6ea6ff 65%, #2c4d7a 100%); box-shadow:0 0 18px #7cc7ff66; }
    header h1{ font-size: clamp(18px, 4.5vw, 22px); margin:0; letter-spacing:0.06em; font-weight:700; }

    .card-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; padding:10px 2px 2px; }
    .tarot{ aspect-ratio: 2.1/3.4; border-radius:14px; background: linear-gradient(145deg, #0f1531, #171c3a); position:relative; border:1px solid var(--card-edge); box-shadow: 0 10px 18px rgba(0,0,0,.35), inset 0 1px 0 #445; cursor:pointer; transform: translateZ(0); }
    .tarot::after{ content:""; position:absolute; inset:10px; border-radius:10px; background: conic-gradient(from 0.25turn, #b5a1ff55, #7cc7ff44, #ffffff22, #b5a1ff55); mask: radial-gradient(closest-side, #0007 80%, transparent 82%) ,linear-gradient(#000,#000); }
    .tarot .sigil{ position:absolute; inset:auto 0 10% 0; margin:auto; text-align:center; font-size: clamp(20px, 6vw, 36px); opacity:.9; filter: drop-shadow(0 2px 4px rgba(0,0,0,.5)); }
    .tarot .stars{ position:absolute; inset:0; opacity:.35; mix-blend-mode:screen; }
    .tarot:active{ transform:scale(.98); }

    .section{ margin: 10px 0 16px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.07); border-radius:16px; padding:12px 12px 14px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .section h2{ margin:0 0 10px; font-size: clamp(15px, 4.2vw, 18px); letter-spacing: .04em; color: var(--accent2); }
    .lead{ color:var(--muted); font-size: 14px; line-height:1.6; }

    .q-choices{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px; }
    .choice{ border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:12px; background:rgba(255,255,255,.02); font-size:15px; }
    .choice input{ margin-right:8px; accent-color: var(--accent2); }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .btn{ flex:1 1 auto; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background: linear-gradient(180deg, rgba(124,199,255,.12), rgba(166,135,255,.10)); color:var(--text); font-weight:600; letter-spacing:.04em; cursor:pointer; text-decoration:none; }
    .btn.secondary{ background: rgba(255,255,255,.04); }
    .btn:active{ transform: translateY(1px); }

    .reveal{
      perspective: 1000px; display:grid; place-items:center; min-height: 240px; position:relative; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(145deg, rgba(31,37,64,.7), rgba(10,12,25,.6));
    }
    .reveal-card{ width:min(260px, 70%); aspect-ratio:2.1/3.4; border-radius:14px; position:relative; transform-style:preserve-3d; transition:transform 700ms cubic-bezier(.2,.7,.2,1); }
    .reveal-card.flipped{ transform: rotateY(180deg); }
    .face{ position:absolute; inset:0; backface-visibility:hidden; border-radius:inherit; border:1px solid var(--card-edge); box-shadow: 0 14px 28px rgba(0,0,0,.45), inset 0 1px 0 #445; display:grid; place-items:center; padding:14px; }
    .front{ background: linear-gradient(145deg, #0f1531, #171c3a); }
    .back{ background: radial-gradient(60% 60% at 50% 25%, #1f2648, #0d132a 60%, #0a0f22 100%); transform: rotateY(180deg); text-align:center; }
    .back h3{ margin:10px 0 6px; font-size:18px; letter-spacing:.06em; }
    .back p{ margin:0; color:var(--muted); font-size:14px; }

    .bars{ display:grid; grid-template-columns:1fr; gap:8px; margin:10px 0; }
    .bar{ background: rgba(255,255,255,.07); border-radius:10px; overflow:hidden; height:12px; }
    .bar>span{ display:block; height:100%; background: linear-gradient(90deg, var(--accent2), var(--accent)); width:0%; transition: width 900ms ease; }
    .score-row{ display:flex; justify-content:space-between; font-size:13px; color:var(--muted); }

    .result{ line-height:1.7; font-size:15px; color:#e9ecff; }

    .ad-slot{ margin-top:12px; border:1px dashed rgba(255,255,255,.15); border-radius:12px; padding:14px; text-align:center; color:var(--muted); font-size:12px; }

    footer{ margin: 18px 0 40px; text-align:center; color:var(--muted); font-size:12px; }
    .small{ font-size:12px; color:var(--muted); }

    /* 小さめ端末向け微調整 */
    @media (max-width:360px){
      .card-grid{ gap:8px; }
      .btn{ padding:10px 12px; font-size:14px; }
      .choice{ padding:10px; font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="wrap">
    <header>
      <div class="moon" aria-hidden="true"></div>
      <h1>Mystic Night Tarot – 今の心理バランス診断</h1>
    </header>

    <!-- ステップ1：カード選択 -->
    <section class="section" id="step1">
      <h2>① 直感で1枚選んでください</h2>
      <p class="lead">目を閉じて深呼吸をひとつ。最初に気になったカードが、いまのあなたを映します。</p>
      <div class="card-grid" id="cardGrid" aria-label="カード一覧"></div>
      <div class="small" style="margin-top:8px;">※ 6枚のうち一枚をタップ</div>
    </section>

    <!-- ステップ2：心理テスト（言葉の選択） -->
    <section class="section" id="step2" hidden>
      <h2>② いま一番しっくり来る言葉は？</h2>
      <p class="lead">直感で選んでください。結果の“ニュアンス”が変わります。</p>
      <div class="q-choices" id="qChoices"></div>
      <div class="btns">
        <button class="btn" id="seeResultBtn" disabled>結果を見る</button>
        <button class="btn secondary" id="reselectBtn">カードを選び直す</button>
      </div>
    </section>

    <!-- ステップ3：結果表示（カードめくり＋心理バランス） -->
    <section class="section" id="step3" hidden>
      <h2>③ 結果</h2>
      <div class="reveal">
        <div class="reveal-card" id="revealCard" aria-live="polite">
          <div class="face front" id="frontFace"></div>
          <div class="face back" id="backFace">
            <div>
              <div style="font-size:40px; line-height:1" id="cardEmoji">🜂</div>
              <h3 id="cardTitle">---</h3>
              <p id="cardPose" class="small">正位置</p>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="score-row"><span>思考</span><span id="pctThink">0%</span></div>
        <div class="bar"><span id="barThink"></span></div>
        <div class="score-row"><span>感情</span><span id="pctFeel">0%</span></div>
        <div class="bar"><span id="barFeel"></span></div>
        <div class="score-row"><span>行動</span><span id="pctAct">0%</span></div>
        <div class="bar"><span id="barAct"></span></div>
        <div class="score-row"><span>直感</span><span id="pctIntui">0%</span></div>
        <div class="bar"><span id="barIntui"></span></div>
      </div>

      <div class="result" id="resultText" style="margin-top:12px"></div>

      <div class="btns">
        <button class="btn" id="againBtn">もう一度</button>
        <a class="btn secondary" id="shareBtn">結果をシェア</a>
        <a class="btn secondary" id="consultBtn" href="#" target="_blank" rel="noopener">詳しい鑑定を依頼</a>
      </div>

      <div class="ad-slot" aria-label="広告枠（ダミー）">
        （広告を表示するスペース）<br/>
        AdSense を使う場合は、この枠を置き換えてください。
      </div>
    </section>

    <footer>
      © <span id="year"></span> Mystic Night Tarot
    </footer>
  </div>

  <script>
    // ---- 星のばらまき（パフォーマンスを考慮した簡易フィールド）
    const starCount = 140;
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
    const starPositions = Array.from({length: starCount}, () => {
      const x = Math.floor(Math.random()*vw);
      const y = Math.floor(Math.random()*vh*1.2);
      const blur = Math.random()*2;
      return `${x}px ${y}px ${blur}px rgba(255,255,255,${0.6+Math.random()*0.4})`;
    }).join(',');
    document.documentElement.style.setProperty('--star-field', starPositions);

    // ---- タロット簡易データ（主要アルカナ一部 + 絵文字）
    const TAROT = [
      { id:'the-sun', name:'太陽', emoji:'☀️', upright:'生命力・成功・喜び・可視化', reversed:'空回り・自信過剰・焦り' },
      { id:'the-moon', name:'月', emoji:'🌙', upright:'無意識・直感・曖昧さ・想像力', reversed:'混乱・不安・誤解' },
      { id:'the-star', name:'星', emoji:'⭐', upright:'希望・ひらめき・癒し・再生', reversed:'期待はずれ・自己不信' },
      { id:'the-hermit', name:'隠者', emoji:'🕯️', upright:'内省・探求・静けさ', reversed:'孤立・閉塞・こだわり' },
      { id:'strength', name:'力', emoji:'🦁', upright:'勇気・優しさ・自己制御', reversed:'衝動・自信の揺らぎ' },
      { id:'justice', name:'正義', emoji:'⚖️', upright:'公平・調整・バランス', reversed:'偏り・迷い・不均衡' },
      { id:'wheel', name:'運命の輪', emoji:'🎡', upright:'転機・流れに乗る・シンクロ', reversed:'停滞・空回り' },
      { id:'death', name:'死神', emoji:'🦋', upright:'終わりと始まり・脱皮', reversed:'手放せない・延命策' },
      { id:'lovers', name:'恋人', emoji:'💞', upright:'選択・ときめき・調和', reversed:'優柔不断・不一致' },
      { id:'magician', name:'魔術師', emoji:'🪄', upright:'スタート・意思・表現', reversed:'準備不足・散漫' },
      { id:'priestess', name:'女教皇', emoji:'📘', upright:'洞察・静観・直感の精度', reversed:'過剰分析・冷たさ' },
      { id:'empress', name:'女帝', emoji:'🌿', upright:'豊かさ・育成・共感', reversed:'甘やかし・過多' }
    ];

    // 心理テストの選択肢（ニュアンスを重み付け）
    const CHOICES = [
      { key:'安心', weights:{ think:+6, feel:+10, act:-2, intui:+2 }, tone:'安定とやさしさを求める波長。' },
      { key:'変化', weights:{ think:+2, feel:-2, act:+10, intui:+4 }, tone:'更新と前進の風を取り込む波長。' },
      { key:'冒険', weights:{ think:-2, feel:+2, act:+8, intui:+12 }, tone:'未知に開く扉へ飛び込む波長。' }
    ];

    // UI参照
    const grid = document.getElementById('cardGrid');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const qBox = document.getElementById('qChoices');
    const seeBtn = document.getElementById('seeResultBtn');
    const reselectBtn = document.getElementById('reselectBtn');

    const revealCard = document.getElementById('revealCard');
    const frontFace = document.getElementById('frontFace');
    const backFace  = document.getElementById('backFace');
    const cardTitle = document.getElementById('cardTitle');
    const cardPose  = document.getElementById('cardPose');
    const cardEmoji = document.getElementById('cardEmoji');

    const bars = {
      think: document.getElementById('barThink'),
      feel:  document.getElementById('barFeel'),
      act:   document.getElementById('barAct'),
      intui: document.getElementById('barIntui')
    };
    const pcts = {
      think: document.getElementById('pctThink'),
      feel:  document.getElementById('pctFeel'),
      act:   document.getElementById('pctAct'),
      intui: document.getElementById('pctIntui')
    };
    const resultText = document.getElementById('resultText');

    const againBtn = document.getElementById('againBtn');
    const shareBtn = document.getElementById('shareBtn');
    const consultBtn = document.getElementById('consultBtn');

    document.getElementById('year').textContent = new Date().getFullYear();

    // 状態
    let chosenIndex = null;   // TAROTのインデックス
    let upright = true;       // 正位置/逆位置
    let choice = null;        // CHOICESのオブジェクト

    // 初期化：6枚をランダムに選び直す
    function setupGrid(){
      grid.innerHTML = '';
      chosenIndex = null; upright = true; choice = null;
      step2.hidden = true; step3.hidden = true; seeBtn.disabled = true;

      const pool = shuffle([...TAROT]).slice(0,6);
      pool.forEach((cardObj, i)=>{
        const el = document.createElement('button');
        el.className = 'tarot'; el.setAttribute('aria-label', 'カード'+(i+1));
        el.innerHTML = `<div class="sigil">✴︎</div>`;
        el.addEventListener('click', ()=> onPick(pool, cardObj));
        grid.appendChild(el);
      });
    }

    function onPick(pool, cardObj){
      // 選択したカードを保存
      chosenIndex = TAROT.findIndex(t => t.id === cardObj.id);
      upright = Math.random() > 0.5; // 50%で逆位置

      // 次のステップ（心理テスト）
      renderQuestion();
      step2.hidden = false;
      // スクロール
      step2.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function renderQuestion(){
      qBox.innerHTML = '';
      CHOICES.forEach((c,i)=>{
        const id = 'c'+i;
        const label = document.createElement('label');
        label.className = 'choice';
        label.innerHTML = `<input type="radio" name="tone" id="${id}" value="${c.key}"/> ${c.key} — <span class="small">${c.tone}</span>`;
        qBox.appendChild(label);
      });
      qBox.addEventListener('change', (ev)=>{
        const val = ev.target && ev.target.value;
        choice = CHOICES.find(c=>c.key===val) || null;
        seeBtn.disabled = !choice;
      }, { once:true });
    }

    // 結果生成ロジック
    function compute(){
      const card = TAROT[chosenIndex];
      const poseText = upright ? '正位置' : '逆位置';
      const base = seedFrom(card.id + poseText + new Date().toDateString());
      // 4軸 0-100
      let think = 40 + ((base%23)-11); // -11..+11
      let feel  = 40 + ((base%19)-9);
      let act   = 40 + ((base%17)-8);
      let intui = 40 + ((base%29)-14);
      // カード性質の補正
      const bias = {
        'the-sun':     {think:+4, feel:+8, act:+10, intui:+0},
        'the-moon':    {think:-4, feel:+6, act:-2, intui:+12},
        'the-star':    {think:+2, feel:+6, act:+2, intui:+10},
        'the-hermit':  {think:+10,feel:+0, act:-4, intui:+6},
        'strength':    {think:+2, feel:+6, act:+8, intui:+0},
        'justice':     {think:+10,feel:+2, act:+0, intui:+0},
        'wheel':       {think:+0, feel:+2, act:+10,intui:+6},
        'death':       {think:+4, feel:+0, act:+8, intui:+4},
        'lovers':      {think:-2, feel:+10,act:+2, intui:+2},
        'magician':    {think:+8, feel:+0, act:+8, intui:+2},
        'priestess':   {think:+8, feel:+0, act:-2, intui:+10},
        'empress':     {think:+2, feel:+10,act:+0, intui:+2}
      }[card.id] || {think:0, feel:0, act:0, intui:0};

      if(!upright){ // 逆位置は一部軸を弱める
        think -= 4; feel -= 4; act -= 6; intui -= 2;
      }
      // 心理テストの重み
      if(choice){
        think += choice.weights.think;
        feel  += choice.weights.feel;
        act   += choice.weights.act;
        intui += choice.weights.intui;
      }
      // カード固有補正
      think += bias.think; feel += bias.feel; act += bias.act; intui += bias.intui;

      // 0-100にクランプ
      const clamp = v => Math.max(0, Math.min(100, Math.round(v)));
      think = clamp(think); feel = clamp(feel); act = clamp(act); intui = clamp(intui);

      return { card, poseText, scores:{think,feel,act,intui} };
    }

    // 結果テキスト
    function buildText(card, poseText, scores){
      const keyline = uprightMsg(card, poseText);
      const focus = Object.entries(scores).sort((a,b)=>b[1]-a[1])[0][0];
      const axisJP = {think:'思考', feel:'感情', act:'行動', intui:'直感'};

      const advice = {
        think: '考えを紙に書き出すと、混線がほどけていきます。3行でOK。',
        feel:  '感情を否定しないで、まず「いまこう感じてる」と言葉に。',
        act:   '5分だけ動く。短時間の着手が流れを作ります。',
        intui: '第一印象を尊重して。ただし一拍置いて事実確認も。'
      }[focus];

      const nuance = choice ? choice.tone : '';

      return `【キーワード】${keyline}\n【いま強い軸】${axisJP[focus]}\n${nuance}\n${card.name}の示す景色に、あなたの現在地が重なっています。`;
    }

    function uprightMsg(card, poseText){
      const t = upright ? card.upright : card.reversed;
      return `${card.name}／${poseText}：${t}`;
    }

    // 乱数ヘルパ
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }
    function seedFrom(str){
      let h=0; for(let i=0;i<str.length;i++){ h = Math.imul(31,h)+str.charCodeAt(i)|0; } return Math.abs(h);
    }

    // UI動作
    seeBtn.addEventListener('click', ()=>{
      if(chosenIndex==null || !choice) return;
      const { card, poseText, scores } = compute();

      // カード面をセットしてアニメーション
      frontFace.innerHTML = '';
      backFace.querySelector('#cardEmoji').textContent = card.emoji;
      cardTitle.textContent = card.name;
      cardPose.textContent  = poseText;

      revealCard.classList.remove('flipped');
      setTimeout(()=>{ revealCard.classList.add('flipped'); }, 60);

      // バーの更新
      bars.think.style.width = scores.think+'%'; pcts.think.textContent = scores.think+'%';
      bars.feel.style.width  = scores.feel+'%';  pcts.feel.textContent  = scores.feel+'%';
      bars.act.style.width   = scores.act+'%';   pcts.act.textContent   = scores.act+'%';
      bars.intui.style.width = scores.intui+'%'; pcts.intui.textContent = scores.intui+'%';

      // テキスト
      resultText.textContent = buildText(card, poseText, scores);

      // セクション表示切替
      step3.hidden = false; step3.scrollIntoView({behavior:'smooth', block:'start'});
    });

    reselectBtn.addEventListener('click', ()=>{ setupGrid(); window.scrollTo({top:0, behavior:'smooth'}); });
    againBtn.addEventListener('click', ()=>{ setupGrid(); window.scrollTo({top:0, behavior:'smooth'}); });

    // 共有
    shareBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const text = `Mystic Night Tarotで心理バランスを診断しました。\n${resultText.textContent}`;
      if(navigator.share){
        try{ await navigator.share({ title: '心理バランス診断', text, url: location.href }); }catch(err){}
      }else{
        navigator.clipboard.writeText(text).then(()=>{
          shareBtn.textContent = 'コピーしました'; setTimeout(()=>shareBtn.textContent='結果をシェア', 1400);
        });
      }
    });

    // 相談リンク（任意で差し替え）
    consultBtn.addEventListener('click', (e)=>{
      if(consultBtn.getAttribute('href')==='#'){
        e.preventDefault();
        alert('「詳しい鑑定を依頼」リンクは、あなたのLINE公式・予約フォームURLに差し替えてください。');
      }
    });

    // 起動
    setupGrid();
  </script>
</body>
</html>

